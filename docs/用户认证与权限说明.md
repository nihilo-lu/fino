# 用户认证、管理与注册功能说明

本文档描述投资财务系统中基于 [streamlit-authenticator](https://github.com/mkhorasani/Streamlit-Authenticator) 的多用户登录、角色权限、用户管理及对外注册功能。

---

## 一、功能概述

| 功能 | 说明 |
|------|------|
| **登录 / 登出** | 使用用户名与密码登录，会话由 Cookie 维持；侧边栏提供「退出登录」。 |
| **角色** | 通过 `config.yaml` 中的 `roles` 区分**管理员**与**普通用户**。 |
| **用户管理** | 仅管理员可见。可**添加、编辑、删除**用户，并设置角色与重置密码。 |
| **个人资料与密码** | 所有登录用户可见。可修改自己的**用户名、昵称、邮箱**和**登录密码**。 |
| **对外注册** | 未登录时，登录页下方提供「没有账号？注册」。可开放注册或仅允许预授权邮箱注册。 |

**不参与认证的入口**：带 `?chart=xxx` 的分享链接无需登录即可访问。

---

## 二、技术栈与依赖

- **认证组件**：`streamlit-authenticator`（基于 Cookie 的会话、bcrypt 密码哈希）
- **配置格式**：YAML（`config.yaml`）
- **依赖**：见 `requirements.txt` 中的 `streamlit-authenticator`、`PyYAML`

认证配置的读写与「是否管理员」判断封装在 `utils/auth_config.py` 中。

---

## 三、配置文件 `config.yaml`

配置文件位于项目根目录，结构如下。

### 3.1 整体结构

```yaml
cookie:
  expiry_days: 30        # 会话 Cookie 有效天数
  key: "..."             # 用于签名 Cookie 的密钥，生产环境请改为随机字符串
  name: "..."            # Cookie 名称

credentials:
  usernames:
    <登录名>:
      email: "..."

      failed_login_attempts: 0   # 由库维护，通常不必手改
      first_name: "..."         # 显示名（名）
      last_name: "..."          # 显示名（姓）
      logged_in: false          # 由库维护
      password: "..."           # 明文会由库自动哈希；管理员在界面新增用户时已写入哈希
      roles: []                 # 留空为普通用户，["admin"] 为管理员

pre-authorized:
  emails: []             # 对外注册时的预授权邮箱；留空表示开放注册
```

### 3.2 字段说明

| 配置块 | 字段 | 说明 |
|--------|------|------|
| **cookie** | `expiry_days` | 登录状态保留天数，0 表示不持久化。 |
| | `key` | Cookie 签名密钥，部署时应使用强随机值。 |
| | `name` | 浏览器中 Cookie 的名称。 |
| **credentials.usernames.\<用户名\>** | `email` | 用户邮箱。 |
| | `first_name` / `last_name` | 界面显示用姓名。 |
| | `password` | 明文密码（库会哈希）或已有哈希值。 |
| | `roles` | 角色列表，包含 `"admin"` 即为管理员。 |
| **pre-authorized** | `emails` | 允许注册的邮箱列表；为空或不存在时**开放注册**。 |

### 3.3 示例

**管理员账号**（可在「用户管理」中操作其他用户）：

```yaml
admin:
  email: admin@example.com
  failed_login_attempts: 0
  first_name: 管理员
  last_name: ""
  logged_in: false
  password: "admin123"   # 建议改为强密码
  roles:
    - admin
```

**普通用户**（只能改自己的资料与密码）：

```yaml
user1:
  email: user1@example.com
  failed_login_attempts: 0
  first_name: 用户
  last_name: "一"
  logged_in: false
  password: "user123"
  roles: []
```

**预授权注册**（仅这些邮箱可注册）：

```yaml
pre-authorized:
  emails:
    - newuser@example.com
```

**开放注册**（任何人可注册）：

```yaml
pre-authorized:
  emails: []
```

---

## 四、登录与会话

### 4.1 登录流程

1. 打开应用（除分享链接外）会先进入登录页。
2. 输入 `config.yaml` 中已有用户的**用户名**和**密码**，点击「登录」。
3. 校验通过后进入主界面，侧边栏显示当前用户名称与「退出登录」。

### 4.2 会话与 Cookie

- 会话由 streamlit-authenticator 通过 Cookie 维护。
- 有效期内再次访问可免输入密码（取决于 `cookie.expiry_days`）。
- 点击「退出登录」即清除会话，需重新登录。

### 4.3 登录后的 session_state

登录成功后，Streamlit 的 `st.session_state` 中会包含（具体以 streamlit-authenticator 实际写入为准）：

| 键 | 含义 |
|----|------|
| `name` | 显示名（如 first_name + last_name） |
| `username` | 登录名 |
| `authentication_status` | 是否已认证（True/False/None） |
| `roles` | 角色列表，用于判断是否为管理员 |

本系统用 `roles` 是否包含 `"admin"` 判断是否为管理员。

---

## 五、角色与权限

### 5.1 角色类型

| 角色 | 设置方式 | 权限 |
|------|----------|------|
| **管理员** | `roles: ["admin"]` | 用户管理（增删改用户、设角色、重置密码）+ 个人资料与密码 + 全部业务功能 |
| **普通用户** | `roles: []` 或不含 `admin` | 个人资料与密码（仅自己）+ 全部业务功能 |

### 5.2 权限与界面对应关系

- **设置 → 用户管理**：仅当 `st.session_state.roles` 中含 `"admin"` 且传入 `config_path` 时显示。
- **设置 → 个人资料与密码**：所有登录用户可见，仅能修改自己的姓名、邮箱和密码。
- 账本、账户、币种、价格、投资类别等业务功能：不按角色区分，登录即可使用。

---

## 六、用户管理（管理员）

**入口**：以管理员身份登录 → 设置 → **用户管理** Tab。

### 6.1 添加用户

在「➕ 添加用户」展开区中填写：

- **登录名**：唯一，登录时使用，创建后不可在界面中修改。
- **密码**：至少 6 位，保存前会经 bcrypt 哈希写入 `config.yaml`。
- **邮箱**、**名/显示名**、**姓**：用于展示和资料管理。
- **角色**：勾选「admin」即为管理员，不勾选为普通用户。

提交后写入 `config.yaml`，新用户即可用该登录名和密码登录。

### 6.2 编辑用户

在用户列表中点击某用户的「编辑」后，可修改：

- 邮箱
- 角色（是否管理员）
- **新密码**：填写则更新密码并写回配置，留空表示不修改密码

**登录名不可在界面中修改**（对应 YAML 中用户键名）。

### 6.3 删除用户

- 可删除**其他**用户，不可删除**当前登录账号**。
- 删除前有二次确认；确认后从 `config.yaml` 的 `credentials.usernames` 中移除该用户。

---

## 七、个人资料与密码（所有用户）

**入口**：设置 → **个人资料与密码** Tab。

### 7.1 修改个人资料

在页面上直接展示「用户名」「昵称」「邮箱」输入框，可改：

- **用户名**（`credentials.usernames` 的键名重命名；修改后需重新登录）
- **昵称**（写入 `first_name`，并清空 `last_name`）
- **邮箱**（`email`）

修改成功后，若传入的 `config_path` 与 `config` 有效，会自动写回 `config.yaml`。

### 7.2 修改密码

使用「修改密码」表单：

- 输入**当前密码**、**新密码**、**确认新密码**。
- 提交后密码被更新并写回 `config.yaml`。

普通用户**只能**通过本 Tab 修改自己的资料和密码，不能访问「用户管理」。

---

## 八、对外注册

### 8.1 入口与展示条件

- **入口**：未登录时，在登录表单下方有「没有账号？注册」及注册表单。
- **展示条件**：仅在 `authentication_status` 不为已登录时显示；已登录用户不会看到注册入口。

### 8.2 注册模式

由 `config.yaml` 中 `pre-authorized.emails` 决定：

| 配置 | 行为 |
|------|------|
| `pre-authorized.emails: []` 或未配置 | **开放注册**：任何人可填写用户名、密码、邮箱等完成注册。 |
| `pre-authorized.emails: ["a@x.com", "b@y.com"]` | **预授权注册**：仅列表中邮箱可完成注册；成功注册后，该邮箱会从预授权列表中移除（若库支持）。 |

### 8.3 注册与配置持久化

- 注册表单由 `authenticator.register_user(...)` 渲染，填写并提交后，新用户会加入内存中的 `config["credentials"]`。
- 通过 `callback=lambda _: save_config(config_path, config)` 在注册成功时把当前 `config` 写回 `config.yaml`，新用户即可用新账号登录。

注册流程不经过「用户管理」界面，直接写 `config.yaml`。

---

## 九、相关代码与文件

| 文件/位置 | 作用 |
|-----------|------|
| **config.yaml** | 认证配置：cookie、用户列表、预授权邮箱。 |
| **app.py** | 加载 config、创建 Authenticate、登录/注册入口、未登录时展示注册区并写回 config；调用设置页时传入 `config_path`、`authenticator`、`config`。 |
| **utils/auth_config.py** | `load_config` / `save_config`、`is_admin(roles)`、`ensure_pre_authorized` 等，供设置页和写回 config 使用。 |
| **views/settings.py** | 设置页：根据 `roles` 与 `config_path` 决定是否展示「用户管理」；「个人资料与密码」中调用 authenticator 的更新资料/重置密码，并在成功后写回 config。 |

### 9.1 auth_config 提供的能力

- `load_config(config_path)`：读取 `config.yaml`。
- `save_config(config_path, config)`：把内存中的配置写回 YAML。
- `is_admin(roles)`：根据 `roles` 是否包含 `"admin"` 判断管理员。
- `ensure_pre_authorized(config)`：保证存在 `pre-authorized.emails` 结构。

---

## 十、安全与运维建议

1. **首次部署**  
   - 修改 `config.yaml` 中所有默认密码。  
   - 将 `cookie.key` 改为足够长、随机的字符串。

2. **config.yaml 与权限**  
   - `config.yaml` 中含用户与密码哈希，应限制文件系统权限，避免被未授权读/写。  
   - 若通过 Git 管理，建议将 `config.yaml` 加入 `.gitignore`，或仅提交 `config.example.yaml`。

3. **密码与哈希**  
   - 在「用户管理」中新增用户时，密码由 `stauth.Hasher.hash()` 哈希后写入配置；登录校验使用同一套机制，无需明文落盘。

4. **不能删当前账号**  
   - 管理员无法在「用户管理」中删除**自己**，需先用其他管理员账号登录再删，避免锁死系统。

5. **对外注册**  
   - 开放注册时需自行评估滥用与爬虫风险；必要时可关闭注册（移除或隐藏注册入口），仅由管理员在「用户管理」中添加用户。

---

## 十一、常见问题

**Q：管理员看不到「用户管理」？**  
检查该用户在 `config.yaml` 的 `roles` 中是否包含 `admin`，例如：`roles: ["admin"]`。并确认 streamlit-authenticator 已把 `roles` 写入 `st.session_state["roles"]`。

**Q：修改个人资料或密码后刷新又变回去？**  
说明写回 `config.yaml` 未生效。确认运行应用时对项目根目录下的 `config.yaml` 有写权限，且传入设置页的 `config_path`、`config` 正确。

**Q：如何只允许指定邮箱注册？**  
在 `config.yaml` 的 `pre-authorized.emails` 中填写允许的邮箱列表；未在该列表中的邮箱将无法完成注册（具体行为以当前使用的 streamlit-authenticator 版本为准）。

**Q：忘记管理员密码怎么办？**  
在服务器上直接编辑 `config.yaml`，将该用户的 `password` 改为新明文密码（应用下次加载时会由库哈希），或使用已有文档中的哈希格式写入。修改后重启或刷新应用使配置生效。

**Q：分享链接需要登录吗？**  
不需要。带 `?chart=xxx` 的分享链接在认证逻辑之前处理，可直接访问，不经过登录与用户管理。

---

## 十二、版本与参考

- 认证与 UI 行为以当前项目所使用的 **streamlit-authenticator** 及 **Streamlit** 版本为准。
- 更多 streamlit-authenticator 能力（如忘记密码、忘记用户名、双因素等）见其官方文档与示例。
- 本说明若有与代码不一致之处，以代码与 `config.yaml` 实际结构为准。

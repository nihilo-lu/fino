# æŠ•èµ„è´¢åŠ¡ç³»ç»Ÿ - å¤šæ•°æ®åº“æ¶æ„è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
3. [æ¨¡å—è¯´æ˜](#æ¨¡å—è¯´æ˜)
4. [SQL å…¼å®¹å±‚](#sql-å…¼å®¹å±‚)
5. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
6. [æ‰©å±•æ–°æ•°æ®åº“](#æ‰©å±•æ–°æ•°æ®åº“)
7. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)

---

## æ¶æ„æ¦‚è¿°

æŠ•èµ„è´¢åŠ¡ç³»ç»Ÿæ”¯æŒå¤šç§æ•°æ®åº“åç«¯ï¼ˆSQLiteã€PostgreSQLã€Cloudflare D1ï¼‰ï¼Œé€šè¿‡**ç»Ÿä¸€æ¥å£ + é€‚é…å™¨æ¨¡å¼**å®ç°æ•°æ®åº“æ— å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚ä¸šåŠ¡å±‚å§‹ç»ˆä½¿ç”¨ SQLite é£æ ¼çš„ SQL å’Œ APIï¼Œç”±å„æ•°æ®åº“å®ç°è´Ÿè´£é€‚é…å·®å¼‚ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           config.yaml (æ•°æ®åº“é…ç½®)                                â”‚
â”‚                    type: sqlite | postgresql | d1                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           utils/db_config.py                                     â”‚
â”‚                     load_database_config / save_database_config                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           utils/db_base.py                                       â”‚
â”‚                    get_db_manager(db_type, ...) â†’ DBManagerBase                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                          â”‚                          â”‚                          â”‚
                    â–¼                          â–¼                          â–¼                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
         â”‚ SQLiteManager    â”‚      â”‚ PostgreSQLManager    â”‚      â”‚ D1Manager            â”‚          â”‚
         â”‚ (db_sqlite_      â”‚      â”‚ (db_postgres_        â”‚      â”‚ (db_d1_manager.py)   â”‚          â”‚
         â”‚  manager.py)     â”‚      â”‚  manager.py)         â”‚      â”‚ é€šè¿‡ HTTP API        â”‚          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                  â”‚                            â”‚
                  â”‚   get_connection()         â”‚   get_connection()
                  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                        â”‚  â”‚                        â”‚
                  â–¼                        â”‚  â–¼                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
         â”‚ sqlite3.Connectionâ”‚              â”‚  â”‚ _PGConnectionWrapper â”‚  â”‚
         â”‚ (åŸç”Ÿ)            â”‚              â”‚  â”‚ (åŒ…è£… psycopg2)      â”‚  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                  â”‚                        â”‚             â”‚              â”‚
                  â”‚                        â”‚             â–¼              â”‚
                  â”‚                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                  â”‚                        â”‚  â”‚ _PGCursorWrapper     â”‚  â”‚
                  â”‚                        â”‚  â”‚ (?â†’%s, lastrowid,    â”‚  â”‚
                  â”‚                        â”‚  â”‚  INSERT OR IGNORE)   â”‚  â”‚
                  â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                  â”‚                        â”‚                            â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         database.py (Database ç±»)                                â”‚
â”‚         ç»Ÿä¸€å…¥å£ï¼ŒæŒæœ‰ db_managerï¼Œå§”æ‰˜ç»™ TransactionCRUD / Analytics            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

1. **å¯åŠ¨æ—¶**ï¼š`app.py` è°ƒç”¨ `Database(config_path=config_path)`
2. **Database** é€šè¿‡ `get_database_config()` è¯»å– `config.yaml` ä¸­çš„ `database` é…ç½®
3. **get_db_manager()** æ ¹æ® `type` åˆ›å»º `SQLiteManager`ã€`PostgreSQLManager` æˆ– `D1Manager`
4. **ä¸šåŠ¡å±‚**ï¼ˆ`crud_transactions`ã€`analytics`ã€`database.py`ï¼‰é€šè¿‡ `db_manager.get_connection()` è·å–è¿æ¥ï¼Œæ‰§è¡Œ SQL
5. **PostgreSQL** ä¸‹ï¼Œè¿æ¥å’Œæ¸¸æ ‡ç»è¿‡åŒ…è£…å™¨ï¼Œè‡ªåŠ¨å®Œæˆ SQL è½¬æ¢ï¼›**D1** é€šè¿‡ HTTP API æ‰§è¡Œ SQL

---

## è®¾è®¡åŸåˆ™

### 1. ä»¥ SQLite ä¸ºã€Œæ ‡å‡†æ–¹è¨€ã€

- ä¸šåŠ¡å±‚ç»Ÿä¸€ä½¿ç”¨ SQLite é£æ ¼ï¼š
  - å ä½ç¬¦ï¼š`?`
  - è‡ªå¢ä¸»é”®ï¼š`cursor.lastrowid`
  - å†²çªå¤„ç†ï¼š`INSERT OR IGNORE`ã€`INSERT OR REPLACE`
- å…¶ä»–æ•°æ®åº“é€šè¿‡**é€‚é…å™¨**è½¬æ¢ä¸ºè‡ªèº«è¯­æ³•ï¼Œä¸šåŠ¡ä»£ç æ— éœ€æ”¹åŠ¨ã€‚

### 2. ç»Ÿä¸€ç®¡ç†å™¨æ¥å£

æ‰€æœ‰æ•°æ®åº“å®ç°å¿…é¡»å®ç° `DBManagerBase` åè®®ï¼š

```python
class DBManagerBase(Protocol):
    def get_connection(self) -> Any: ...
    def close(self) -> None: ...
```

- `get_connection()` è¿”å›çš„è¿æ¥éœ€æ”¯æŒï¼š`cursor()`ã€`commit()`ã€`rollback()`ã€`close()`
- æ¸¸æ ‡éœ€æ”¯æŒï¼š`execute()`ã€`fetchone()`ã€`fetchall()`ã€`rowcount`ã€`lastrowid`ï¼ˆæˆ–ç­‰æ•ˆï¼‰

### 3. é…ç½®é©±åŠ¨

- æ•°æ®åº“ç±»å‹å’Œè¿æ¥å‚æ•°ä» `config.yaml` çš„ `database` æ®µè¯»å–
- æ”¯æŒåœ¨è®¾ç½®é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰ä¸­ä¿®æ”¹å¹¶æŒä¹…åŒ–
- ä¿®æ”¹åéœ€é‡å¯åº”ç”¨ç”Ÿæ•ˆ

### 4. å‘åå…¼å®¹

- æœªé…ç½® `database` æ—¶ï¼Œé»˜è®¤ä½¿ç”¨ SQLiteï¼Œè·¯å¾„ä¸º `investment.db`
- åŸæœ‰ `Database(db_path="xxx.db")` è°ƒç”¨ä»å¯ä½¿ç”¨

---

## æ¨¡å—è¯´æ˜

### 1. `utils/db_base.py` â€” å·¥å‚ä¸åè®®

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| `DBManagerBase` | åè®®ï¼Œå®šä¹‰ `get_connection()`ã€`close()` |
| `get_db_manager()` | å·¥å‚å‡½æ•°ï¼Œæ ¹æ® `db_type` åˆ›å»ºå¯¹åº”ç®¡ç†å™¨ |

```python
# ä½¿ç”¨ç¤ºä¾‹
from utils.db_base import get_db_manager

manager = get_db_manager(db_type="sqlite", db_path="investment.db")
# æˆ–
manager = get_db_manager(db_type="postgresql", pg_host="localhost", pg_database="investment", ...)
conn = manager.get_connection()
```

### 2. `utils/db_config.py` â€” é…ç½®è¯»å†™

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `load_database_config(config_path)` | ä» config.yaml è¯»å– `database` æ®µ |
| `get_database_config(config_path)` | è¯»å–å¹¶åˆå¹¶é»˜è®¤å€¼ï¼Œè¿”å›å®Œæ•´é…ç½® |
| `save_database_config(...)` | å°†æ•°æ®åº“é…ç½®å†™å› config.yaml |

é…ç½®ç»“æ„ï¼š

```yaml
database:
  type: sqlite | postgresql | d1
  sqlite:
    path: investment.db
  postgresql:
    host: localhost
    port: 5432
    database: investment
    user: postgres
    password: ""
    sslmode: prefer
  d1:
    account_id: ""   # Cloudflare è´¦æˆ· ID
    database_id: ""  # D1 æ•°æ®åº“ UUID
    api_token: ""    # D1 è¯»å†™æƒé™çš„ API Token
```

### 3. `utils/db_sqlite_manager.py` â€” SQLite å®ç°

- ç›´æ¥ä½¿ç”¨ `sqlite3`ï¼Œæ— é¢å¤–åŒ…è£…
- è´Ÿè´£å»ºè¡¨ã€è¿ç§»ã€åˆå§‹åŒ–é»˜è®¤æ•°æ®
- è¿”å›åŸç”Ÿ `sqlite3.Connection`

### 4. `utils/db_postgres_manager.py` â€” PostgreSQL å®ç°

- ä¾èµ– `psycopg2`ï¼ˆæˆ– `psycopg2-binary`ï¼‰
- ä½¿ç”¨**è¿æ¥åŒ…è£…å™¨**å’Œ**æ¸¸æ ‡åŒ…è£…å™¨**å®ç°ä¸ SQLite çš„å…¼å®¹
- è¡¨ç»“æ„ä½¿ç”¨ PostgreSQL è¯­æ³•ï¼ˆ`SERIAL`ã€`VARCHAR`ã€`DOUBLE PRECISION` ç­‰ï¼‰

### 5. `utils/db_d1_manager.py` â€” Cloudflare D1 å®ç°

- é€šè¿‡ Cloudflare D1 HTTP REST API è¿æ¥
- D1 åŸºäº SQLiteï¼ŒSQL è¯­æ³•å…¼å®¹ï¼ˆ`?` å ä½ç¬¦ã€`INSERT OR IGNORE`ï¼‰
- æ— éœ€é¢å¤–ä¾èµ–ï¼Œä½¿ç”¨æ ‡å‡†åº“ `urllib` å‘é€è¯·æ±‚
- éœ€é…ç½® `account_id`ã€`database_id`ã€`api_token`

---

## SQL å…¼å®¹å±‚

PostgreSQL ä¸ SQLite åœ¨è¯­æ³•ä¸Šå­˜åœ¨å·®å¼‚ï¼Œç”± `_convert_sql_sqlite_to_pg()` å’Œ `_PGCursorWrapper` ç»Ÿä¸€å¤„ç†ã€‚

### 1. å ä½ç¬¦

| SQLite | PostgreSQL |
|--------|------------|
| `?` | `%s` |

æ‰€æœ‰ `?` åœ¨æ‰§è¡Œå‰æ›¿æ¢ä¸º `%s`ã€‚

### 2. è‡ªå¢ä¸»é”®ï¼ˆlastrowidï¼‰

| SQLite | PostgreSQL |
|--------|------------|
| `cursor.lastrowid` è‡ªåŠ¨å¯ç”¨ | éœ€åœ¨ INSERT åè·å– |

å¤„ç†æ–¹å¼ï¼š

- å¯¹æ™®é€š `INSERT INTO ... VALUES (...)`ï¼Œè‡ªåŠ¨è¿½åŠ  `RETURNING id`ï¼Œæ‰§è¡Œåä»ç»“æœå– `id` èµ‹ç»™ `cursor.lastrowid`
- å¯¹ `INSERT ... ON CONFLICT` ç­‰ï¼Œä½¿ç”¨ `SELECT lastval()` è·å–æœ€åæ’å…¥çš„åºåˆ—å€¼

### 3. å†²çªå¤„ç†

| SQLite | PostgreSQL |
|--------|------------|
| `INSERT OR IGNORE` | `INSERT ... ON CONFLICT (...) DO NOTHING` |
| `INSERT OR REPLACE` | `INSERT ... ON CONFLICT (...) DO UPDATE SET ...` |

æ ¹æ®è¡¨çš„ä¸»é”®/å”¯ä¸€çº¦æŸè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ `ON CONFLICT` å­å¥ã€‚

### 4. å…ƒæ•°æ®æŸ¥è¯¢

| SQLite | PostgreSQL |
|--------|------------|
| `SELECT ... FROM sqlite_master WHERE name='table_name'` | `SELECT 1 FROM information_schema.tables WHERE table_name='table_name'` |

ç”¨äºè¡¨å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆå¦‚ `return_rate_sqlite` ä¸­çš„é€»è¾‘ï¼‰ã€‚

### 5. PRAGMA

SQLite çš„ `PRAGMA`ï¼ˆå¦‚ `PRAGMA foreign_keys = ON`ï¼‰åœ¨ PostgreSQL ä¸­æ— å¯¹åº”æ¦‚å¿µï¼ŒåŒ…è£…å™¨ç›´æ¥è·³è¿‡æ‰§è¡Œã€‚

---

## é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶

æ•°æ®åº“é…ç½®å­˜æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `config.yaml` ä¸­ï¼Œä¸è®¤è¯é…ç½®å…±ç”¨ï¼š

```yaml
database:
  type: sqlite
  sqlite:
    path: investment.db
  postgresql:
    host: localhost
    port: 5432
    database: investment
    user: postgres
    password: ""
    sslmode: prefer

cookie: ...
credentials: ...
```

### è®¾ç½®é¡µé¢

- è·¯å¾„ï¼šè®¾ç½® â†’ æ•°æ®åº“è®¾ç½®ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
- å¯åˆ‡æ¢ SQLite / PostgreSQLï¼Œå¹¶å¡«å†™å¯¹åº”è¿æ¥å‚æ•°
- ä¿å­˜åå†™å…¥ `config.yaml`ï¼Œéœ€é‡å¯åº”ç”¨ç”Ÿæ•ˆ

### ä»£ç ä¸­ä½¿ç”¨

```python
# ä»é…ç½®åˆå§‹åŒ–ï¼ˆæ¨èï¼‰
from database import Database
db = Database(config_path="config.yaml")

# è¦†ç›–é…ç½®
db = Database(db_type="postgresql", pg_host="192.168.1.100", pg_database="prod")
```

---

## æ‰©å±•æ–°æ•°æ®åº“

æ–°å¢æ•°æ®åº“ç±»å‹ï¼ˆå¦‚ MySQLï¼‰çš„æ­¥éª¤ï¼š

### 1. å®ç°ç®¡ç†å™¨

åœ¨ `utils/` ä¸‹æ–°å»º `db_mysql_manager.py`ï¼ˆæˆ–ç±»ä¼¼åç§°ï¼‰ï¼Œå®ç°ï¼š

```python
class MySQLManager:
    def __init__(self, host, port, database, user, password, ...):
        # å»ºç«‹è¿æ¥ã€å»ºè¡¨ã€åˆå§‹åŒ–
        ...

    def get_connection(self):
        # è¿”å›è¿æ¥ï¼Œå¿…è¦æ—¶ä½¿ç”¨åŒ…è£…å™¨ä»¥å…¼å®¹ ?ã€lastrowid ç­‰
        return self._conn

    def close(self):
        ...
```

### 2. å®ç° SQL è½¬æ¢

è‹¥ç›®æ ‡æ•°æ®åº“ä¸ SQLite è¯­æ³•ä¸åŒï¼Œéœ€å®ç°è½¬æ¢é€»è¾‘ï¼ˆå¯å‚è€ƒ `_convert_sql_sqlite_to_pg`ï¼‰ï¼š

- å ä½ç¬¦ï¼š`?` â†’ ç›®æ ‡å ä½ç¬¦
- `INSERT OR IGNORE` / `INSERT OR REPLACE` â†’ ç›®æ ‡è¯­æ³•
- `lastrowid` çš„è·å–æ–¹å¼

### 3. æ³¨å†Œåˆ°å·¥å‚

åœ¨ `utils/db_base.py` çš„ `get_db_manager()` ä¸­å¢åŠ åˆ†æ”¯ï¼š

```python
elif db_type == "mysql":
    from utils.db_mysql_manager import MySQLManager
    return MySQLManager(...)
```

### 4. æ‰©å±•é…ç½®

åœ¨ `db_config.py` ä¸­å¢åŠ  MySQL çš„é…ç½®é¡¹ï¼Œå¹¶åœ¨è®¾ç½®é¡µé¢å¢åŠ å¯¹åº”è¡¨å•ã€‚

---

## ä½¿ç”¨æŒ‡å—

### SQLiteï¼ˆé»˜è®¤ï¼‰

- æ— éœ€é¢å¤–é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ `investment.db`
- é€‚åˆä¸ªäººæœ¬åœ°ä½¿ç”¨ã€å•æœºéƒ¨ç½²

### PostgreSQL

1. **å®‰è£…ä¾èµ–**ï¼š`pip install psycopg2-binary`
2. **åˆ›å»ºæ•°æ®åº“**ï¼š`createdb investment`
3. **é…ç½®**ï¼šåœ¨è®¾ç½® â†’ æ•°æ®åº“è®¾ç½®ä¸­é€‰æ‹© PostgreSQLï¼Œå¡«å†™ hostã€portã€databaseã€userã€password ç­‰
4. **é‡å¯åº”ç”¨**ï¼šä½¿é…ç½®ç”Ÿæ•ˆ

### æ•°æ®è¿ç§»ï¼ˆSQLite â†’ PostgreSQL / D1ï¼‰

- å½“å‰éœ€æ‰‹åŠ¨è¿ç§»æ•°æ®
- å¯è€ƒè™‘ä½¿ç”¨ `pgloader` æˆ–ç¼–å†™å¯¼å‡º/å¯¼å…¥è„šæœ¬ï¼Œå°† SQLite æ•°æ®å¯¼å…¥ PostgreSQL
- D1 å¯é€šè¿‡ wrangler d1 execute æ‰§è¡Œ SQL å¯¼å…¥

---

## é™„å½•ï¼šæ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `utils/db_base.py` | åè®®å®šä¹‰ã€å·¥å‚å‡½æ•° |
| `utils/db_config.py` | é…ç½®åŠ è½½ä¸ä¿å­˜ |
| `utils/db_sqlite_manager.py` | SQLite å®ç° |
| `utils/db_postgres_manager.py` | PostgreSQL å®ç°åŠ SQL å…¼å®¹å±‚ |
| `utils/db_d1_manager.py` | Cloudflare D1 å®ç°ï¼ˆHTTP APIï¼‰ |
| `database.py` | ç»Ÿä¸€å…¥å£ï¼Œæ•´åˆå„å±‚ |
| `config.yaml` | æ•°æ®åº“ä¸è®¤è¯é…ç½® |
| `SettingsView.js` | æ•°æ®åº“è®¾ç½® UIï¼ˆç®¡ç†å‘˜ï¼‰ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æœ€åæ›´æ–°**ï¼š2025-02-04

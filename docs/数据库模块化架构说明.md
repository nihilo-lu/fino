# æŠ•èµ„è´¢åŠ¡ç³»ç»Ÿ - æ¨¡å—åŒ–æ¶æ„è¯´æ˜æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [æ¨¡å—è¯´æ˜](#æ¨¡å—è¯´æ˜)
3. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
4. [API æ–‡æ¡£](#api-æ–‡æ¡£)
5. [ç¤ºä¾‹ä»£ç ](#ç¤ºä¾‹ä»£ç )
6. [è¿ç§»æŒ‡å—](#è¿ç§»æŒ‡å—)

---

## æ¶æ„æ¦‚è¿°

æŠ•èµ„è´¢åŠ¡ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚æ¨¡å—åŒ–æ¶æ„ï¼Œå°†æ•°æ®åº“æ“ä½œã€ä¸šåŠ¡é€»è¾‘å’Œè®¡ç®—é€»è¾‘æ¸…æ™°åˆ†ç¦»ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         database.py (ä¸»å…¥å£)            â”‚
â”‚   ç»Ÿä¸€æ¥å£ï¼Œæ•´åˆå„æ¨¡å—ï¼Œä¿æŒå‘åå…¼å®¹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚          â”‚
    â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸºç¡€å±‚   â”‚ â”‚  ä¸šåŠ¡æ“ä½œå±‚   â”‚ â”‚  é€»è¾‘è®¡ç®—å±‚   â”‚
â”‚         â”‚ â”‚              â”‚ â”‚              â”‚
â”‚db_sqliteâ”‚ â”‚crud_transactiâ”‚ â”‚  analytics   â”‚
â”‚_manager â”‚ â”‚    ons.py    â”‚ â”‚     .py      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ä¼˜åŠ¿

- âœ… **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£æ˜ç¡®ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… **ä»£ç å¤ç”¨**ï¼šæ¨¡å—å¯ç‹¬ç«‹ä½¿ç”¨ï¼Œé¿å…ä»£ç é‡å¤
- âœ… **æ˜“äºæµ‹è¯•**ï¼šå„æ¨¡å—å¯ç‹¬ç«‹è¿›è¡Œå•å…ƒæµ‹è¯•
- âœ… **å‘åå…¼å®¹**ï¼šåŸæœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°åŠŸèƒ½å¯åœ¨å¯¹åº”æ¨¡å—ä¸­è½»æ¾æ·»åŠ 

---

## æ¨¡å—è¯´æ˜

### 1. åŸºç¡€è®¾æ–½å±‚ - `utils/db_sqlite_manager.py`

**èŒè´£**ï¼šæ•°æ®åº“è¿æ¥ã€è¡¨ç»“æ„ç®¡ç†ã€æ•°æ®åº“è¿ç§»å’Œåˆå§‹åŒ–

**ä¸»è¦åŠŸèƒ½**ï¼š
- æ•°æ®åº“è¿æ¥ç®¡ç†
- åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
- æ•°æ®åº“è¿ç§»ï¼ˆç‰ˆæœ¬å‡çº§ï¼‰
- åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆå¸ç§ã€ç±»åˆ«ã€è´¦æœ¬ç­‰ï¼‰

**æ ¸å¿ƒç±»**ï¼š
```python
class SQLiteManager:
    def __init__(self, db_path: str = "investment.db")
    def get_connection(self) -> sqlite3.Connection
    def close(self)
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ•°æ®åº“åˆå§‹åŒ–
- è¡¨ç»“æ„åˆ›å»ºå’Œè¿ç§»
- è·å–æ•°æ®åº“è¿æ¥

---

### 2. ä¸šåŠ¡æ“ä½œå±‚ - `crud_transactions.py`

**èŒè´£**ï¼šäº¤æ˜“è®°å½•çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼ˆä¹°å…¥ã€å–å‡ºã€åˆ†çº¢ç­‰ï¼‰

**ä¸»è¦åŠŸèƒ½**ï¼š
- æ·»åŠ äº¤æ˜“è®°å½•ï¼ˆä¹°å…¥ã€å–å‡ºã€åˆ†çº¢ç­‰ï¼‰
- æŸ¥è¯¢äº¤æ˜“è®°å½•ï¼ˆæ”¯æŒå¤šæ¡ä»¶ç­›é€‰ï¼‰
- æ›´æ–°äº¤æ˜“è®°å½•
- åˆ é™¤äº¤æ˜“è®°å½•
- èµ„é‡‘æ˜ç»†ç®¡ç†ï¼ˆæ”¯æŒå¤šå€Ÿå¤šè´·ï¼‰

**æ ¸å¿ƒç±»**ï¼š
```python
class TransactionCRUD:
    def __init__(self, db_manager: SQLiteManager)
    
    # äº¤æ˜“è®°å½•æ“ä½œ
    def add_transaction(transaction: Dict, analytics) -> bool
    def get_transactions(...) -> pd.DataFrame
    def get_transaction_by_id(transaction_id: int) -> Optional[Dict]
    def update_transaction(transaction_id: int, transaction: Dict, analytics) -> bool
    def delete_transaction(transaction_id: int, analytics, rebuild_positions: bool = True) -> bool
    
    # èµ„é‡‘æ˜ç»†æ“ä½œ
    def add_fund_transaction(fund_trans: Dict, analytics) -> bool
    def get_fund_transactions(...) -> pd.DataFrame
    def get_fund_transaction_by_id(fund_trans_id: int) -> Optional[Dict]
    def delete_fund_transaction(fund_trans_id: int) -> bool
    def add_transaction_with_fund(transaction: Dict, analytics) -> bool
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- è®°å½•ä¹°å…¥/å–å‡ºäº¤æ˜“
- è®°å½•åˆ†çº¢æ”¶å…¥
- æŸ¥è¯¢å†å²äº¤æ˜“
- ä¿®æ”¹æˆ–åˆ é™¤äº¤æ˜“è®°å½•
- ç®¡ç†èµ„é‡‘æµæ°´

---

### 3. é€»è¾‘è®¡ç®—å±‚ - `analytics.py`

**èŒè´£**ï¼šæ”¶ç›Šç‡è®¡ç®—ã€æŒä»“æˆæœ¬è®¡ç®—ã€èµ„äº§å æ¯”åˆ†æç­‰

**ä¸»è¦åŠŸèƒ½**ï¼š
- æŒä»“ä¿¡æ¯è®¡ç®—ï¼ˆæˆæœ¬ã€å¸‚å€¼ã€æ”¶ç›Šç‡ï¼‰
- æŠ•èµ„ç»„åˆç»Ÿè®¡ï¼ˆæ€»æˆæœ¬ã€æ€»å¸‚å€¼ã€æ€»ç›ˆäºã€æ”¶ç›Šç‡ï¼‰
- èµ„äº§å æ¯”åˆ†æ
- FIFO/WAC æˆæœ¬è®¡ç®—æ–¹æ³•
- æ±‡ç‡è½¬æ¢

**æ ¸å¿ƒç±»**ï¼š
```python
class Analytics:
    def __init__(self, db_manager: SQLiteManager)
    
    # æŒä»“ç›¸å…³
    def get_positions(ledger_id: Optional[int] = None, account_id: Optional[int] = None) -> pd.DataFrame
    def update_position(transaction: Dict, transaction_id: int)
    def rebuild_all_positions()
    def update_position_price(position_id: int, new_price: float) -> bool
    
    # ç»Ÿè®¡åˆ†æ
    def get_portfolio_stats(ledger_id: Optional[int] = None, account_id: Optional[int] = None) -> Dict
    def get_asset_allocation(ledger_id: Optional[int] = None, account_id: Optional[int] = None) -> pd.DataFrame
    
    # æˆæœ¬è®¡ç®—æ–¹æ³•
    def get_ledger_cost_method(ledger_id: int) -> str
    def _get_inventory_manager(ledger_id: int)  # è¿”å› FIFO æˆ– WAC åº“å­˜ç®¡ç†å™¨
    
    # æ±‡ç‡ç›¸å…³
    def get_exchange_rate(currency: str) -> float
    def convert_to_cny(amount: float, currency: str) -> float
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- è®¡ç®—æŒä»“æ”¶ç›Šç‡
- æŸ¥çœ‹æŠ•èµ„ç»„åˆç»Ÿè®¡
- åˆ†æèµ„äº§é…ç½®å æ¯”
- æ›´æ–°æŒä»“ä»·æ ¼
- æ±‡ç‡è½¬æ¢

---

### 4. ä¸»å…¥å£ - `database.py`

**èŒè´£**ï¼šç»Ÿä¸€æ¥å£ï¼Œæ•´åˆå„æ¨¡å—ï¼Œä¿æŒå‘åå…¼å®¹

**ä¸»è¦åŠŸèƒ½**ï¼š
- æä¾›ç»Ÿä¸€çš„ `Database` ç±»æ¥å£
- æ•´åˆæ‰€æœ‰æ¨¡å—åŠŸèƒ½
- ä¿æŒä¸åŸæœ‰ä»£ç çš„å…¼å®¹æ€§
- æä¾›ä¾¿æ·çš„å¿«æ·æ–¹æ³•

**æ ¸å¿ƒç±»**ï¼š
```python
class Database:
    def __init__(self, db_path: str = "investment.db")
    
    # å±æ€§
    self.db_manager: SQLiteManager      # åŸºç¡€è®¾æ–½å±‚
    self.transaction_crud: TransactionCRUD  # ä¸šåŠ¡æ“ä½œå±‚
    self.analytics: Analytics           # é€»è¾‘è®¡ç®—å±‚
    
    # æ‰€æœ‰åŸæœ‰æ–¹æ³•ä¿æŒä¸å˜ï¼Œå†…éƒ¨å§”æ‰˜ç»™ç›¸åº”æ¨¡å—
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ä½œä¸ºä¸»è¦å…¥å£ä½¿ç”¨ï¼ˆæ¨èï¼‰
- ä¿æŒä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§
- å¿«é€Ÿè®¿é—®æ‰€æœ‰åŠŸèƒ½

---

## ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ä½¿ç”¨ï¼ˆæ¨èæ–¹å¼ï¼‰

ä½¿ç”¨ `Database` ç±»ä½œä¸ºä¸»å…¥å£ï¼Œè¿™æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼š

```python
from database import Database

# åˆå§‹åŒ–æ•°æ®åº“
db = Database()

# æ·»åŠ äº¤æ˜“è®°å½•
transaction = {
    'ledger_id': 1,
    'account_id': 1,
    'date': '2025-01-26',
    'type': 'ä¹°å…¥',
    'category': 'è‚¡ç¥¨',
    'code': 'SH.600519',
    'name': 'è´µå·èŒ…å°',
    'quantity': 100,
    'price': 1800.0,
    'currency': 'CNY',
    'amount': 180000.0,
    'fee': 5.0,
    'notes': 'æµ‹è¯•ä¹°å…¥'
}
db.add_transaction(transaction)

# æŸ¥è¯¢äº¤æ˜“è®°å½•
transactions = db.get_transactions(ledger_id=1, limit=10)

# è·å–æŒä»“ä¿¡æ¯
positions = db.get_positions(ledger_id=1)

# è·å–æŠ•èµ„ç»„åˆç»Ÿè®¡
stats = db.get_portfolio_stats(ledger_id=1)
print(f"æ€»æˆæœ¬: {stats['total_cost_cny']:.2f}")
print(f"æ€»å¸‚å€¼: {stats['total_value_cny']:.2f}")
print(f"æ”¶ç›Šç‡: {stats['profit_rate']:.2f}%")

# å…³é—­è¿æ¥
db.close()
```

### æ¨¡å—åŒ–ä½¿ç”¨ï¼ˆé«˜çº§æ–¹å¼ï¼‰

å¦‚æœéœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å„ä¸ªæ¨¡å—ï¼š

```python
from utils.db_sqlite_manager import SQLiteManager
from crud_transactions import TransactionCRUD
from analytics import Analytics

# åˆå§‹åŒ–å„æ¨¡å—
db_manager = SQLiteManager("investment.db")
transaction_crud = TransactionCRUD(db_manager)
analytics = Analytics(db_manager)

# ä½¿ç”¨ä¸šåŠ¡æ“ä½œå±‚
transaction = {...}  # äº¤æ˜“æ•°æ®
transaction_crud.add_transaction(transaction, analytics)

# ä½¿ç”¨é€»è¾‘è®¡ç®—å±‚
positions = analytics.get_positions(ledger_id=1)
stats = analytics.get_portfolio_stats(ledger_id=1)
```

---

## API æ–‡æ¡£

### Database ç±»

#### è´¦æœ¬ç®¡ç†

```python
# è·å–æ‰€æœ‰è´¦æœ¬
ledgers = db.get_ledgers() -> pd.DataFrame

# æ·»åŠ è´¦æœ¬
db.add_ledger(name: str, description: str = "", cost_method: str = "FIFO") -> bool

# æ›´æ–°è´¦æœ¬
db.update_ledger(ledger_id: int, name: str, description: str, cost_method: str) -> bool

# åˆ é™¤è´¦æœ¬
db.delete_ledger(ledger_id: int) -> bool

# è·å–è´¦æœ¬æˆæœ¬è®¡ç®—æ–¹æ³•
cost_method = db.get_ledger_cost_method(ledger_id: int) -> str  # "FIFO" æˆ– "WAC"

# æ›´æ–°è´¦æœ¬æˆæœ¬è®¡ç®—æ–¹æ³•
db.update_ledger_cost_method(ledger_id: int, cost_method: str) -> bool
```

#### è´¦æˆ·ç®¡ç†

```python
# è·å–è´¦æˆ·åˆ—è¡¨
accounts = db.get_accounts(ledger_id: Optional[int] = None) -> pd.DataFrame

# æ·»åŠ è´¦æˆ·
db.add_account(ledger_id: int, name: str, acc_type: str, 
               currency: str = 'CNY', description: str = "") -> bool

# æ›´æ–°è´¦æˆ·
db.update_account(account_id: int, name: str, acc_type: str,
                  currency: str = 'CNY', description: str = "") -> bool

# åˆ é™¤è´¦æˆ·
db.delete_account(account_id: int) -> bool

# è·å–è´¦æˆ·ç›¸å…³æ•°é‡
counts = db.get_account_related_counts(account_id: int) -> dict
```

#### äº¤æ˜“ç®¡ç†

```python
# æ·»åŠ äº¤æ˜“è®°å½•
db.add_transaction(transaction: Dict) -> bool

# è·å–äº¤æ˜“è®°å½•
transactions = db.get_transactions(
    ledger_id: Optional[int] = None,
    account_id: Optional[int] = None,
    trans_type: Optional[str] = None,  # "ä¹°å…¥", "å–å‡º", "åˆ†çº¢" ç­‰
    category: Optional[str] = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    limit: Optional[int] = None
) -> pd.DataFrame

# æ ¹æ®IDè·å–äº¤æ˜“è®°å½•
transaction = db.get_transaction_by_id(transaction_id: int) -> Optional[Dict]

# æ›´æ–°äº¤æ˜“è®°å½•
db.update_transaction(transaction_id: int, transaction: Dict) -> bool

# åˆ é™¤äº¤æ˜“è®°å½•
db.delete_transaction(transaction_id: int, rebuild_positions: bool = True) -> bool
```

#### æŒä»“ç®¡ç†

```python
# è·å–æŒä»“ä¿¡æ¯ï¼ˆåŒ…å«æ”¶ç›Šç‡è®¡ç®—ï¼‰
positions = db.get_positions(
    ledger_id: Optional[int] = None,
    account_id: Optional[int] = None
) -> pd.DataFrame

# è·å–æŠ•èµ„ç»„åˆç»Ÿè®¡
stats = db.get_portfolio_stats(
    ledger_id: Optional[int] = None,
    account_id: Optional[int] = None
) -> Dict
# è¿”å›: {
#     'total_cost': float,        # æ€»æˆæœ¬ï¼ˆåŸå¸ç§ï¼‰
#     'total_value': float,        # æ€»å¸‚å€¼ï¼ˆåŸå¸ç§ï¼‰
#     'total_cost_cny': float,     # æ€»æˆæœ¬ï¼ˆäººæ°‘å¸ï¼‰
#     'total_value_cny': float,    # æ€»å¸‚å€¼ï¼ˆäººæ°‘å¸ï¼‰
#     'total_profit': float,        # æ€»ç›ˆäºï¼ˆåŸå¸ç§ï¼‰
#     'total_profit_cny': float,    # æ€»ç›ˆäºï¼ˆäººæ°‘å¸ï¼‰
#     'profit_rate': float,          # æ”¶ç›Šç‡ï¼ˆ%ï¼‰
#     'position_count': int          # æŒä»“æ•°é‡
# }

# æ›´æ–°æŒä»“ä»·æ ¼
db.update_position_price(position_id: int, new_price: float) -> bool

# æ‰¹é‡æ›´æ–°æ‰€æœ‰æŒä»“ä»·æ ¼
results = db.update_all_positions_price(price_fetch_days: int = None) -> Dict
```

#### èµ„é‡‘æ˜ç»†ç®¡ç†

```python
# æ·»åŠ èµ„é‡‘æ˜ç»†ï¼ˆæ”¯æŒå¤šå€Ÿå¤šè´·ï¼‰
db.add_fund_transaction(fund_trans: Dict) -> bool

# è·å–èµ„é‡‘æ˜ç»†
fund_transactions = db.get_fund_transactions(
    ledger_id: Optional[int] = None,
    account_id: Optional[int] = None,
    trans_type: Optional[str] = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    limit: Optional[int] = None
) -> pd.DataFrame

# æ ¹æ®IDè·å–èµ„é‡‘æ˜ç»†
fund_trans = db.get_fund_transaction_by_id(fund_trans_id: int) -> Optional[Dict]

# åˆ é™¤èµ„é‡‘æ˜ç»†
db.delete_fund_transaction(fund_trans_id: int) -> bool

# æ·»åŠ äº¤æ˜“å¹¶åŒæ—¶è®°å½•èµ„é‡‘æ˜ç»†
db.add_transaction_with_fund(transaction: Dict) -> bool

# è·å–è´¦æˆ·èµ„é‡‘ä½™é¢ç»Ÿè®¡
balance = db.get_account_balance(account_id: int) -> Dict
```

#### å¸ç§å’Œç±»åˆ«ç®¡ç†

```python
# å¸ç§ç®¡ç†
currencies = db.get_currencies() -> pd.DataFrame
db.add_currency(code: str, name: str, symbol: str, rate: float) -> bool
db.update_exchange_rate(code: str, rate: float) -> bool
rate = db.get_exchange_rate(currency: str) -> float
cny_amount = db.convert_to_cny(amount: float, currency: str) -> float

# æ‰¹é‡æ›´æ–°æ±‡ç‡
results = db.update_all_exchange_rates(price_fetch_days: int = None) -> Dict

# ç±»åˆ«ç®¡ç†
categories = db.get_categories() -> pd.DataFrame
db.add_category(name: str, description: str = None) -> bool
db.update_category(category_id: int, name: str, description: str = None) -> bool
db.delete_category(category_id: int) -> bool
usage = db.get_category_usage_count(category_id: int) -> Dict
```

---

## ç¤ºä¾‹ä»£ç 

### ç¤ºä¾‹ 1ï¼šå®Œæ•´çš„ä¹°å…¥å–å‡ºæµç¨‹

```python
from database import Database

db = Database()

# 1. ä¹°å…¥è‚¡ç¥¨
buy_transaction = {
    'ledger_id': 1,
    'account_id': 1,
    'date': '2025-01-20',
    'type': 'ä¹°å…¥',
    'category': 'è‚¡ç¥¨',
    'code': 'SH.600519',
    'name': 'è´µå·èŒ…å°',
    'quantity': 100,
    'price': 1800.0,
    'currency': 'CNY',
    'amount': 180000.0,
    'fee': 5.0,
    'notes': 'é¦–æ¬¡ä¹°å…¥'
}
db.add_transaction(buy_transaction)

# 2. æŸ¥çœ‹æŒä»“
positions = db.get_positions(ledger_id=1)
print(positions[['code', 'name', 'quantity', 'avg_cost', 'current_price', 'profit_rate']])

# 3. å–å‡ºéƒ¨åˆ†è‚¡ç¥¨
sell_transaction = {
    'ledger_id': 1,
    'account_id': 1,
    'date': '2025-01-26',
    'type': 'å–å‡º',
    'category': 'è‚¡ç¥¨',
    'code': 'SH.600519',
    'name': 'è´µå·èŒ…å°',
    'quantity': 50,  # å–å‡º50è‚¡
    'price': 1900.0,
    'currency': 'CNY',
    'amount': 95000.0,
    'fee': 5.0,
    'notes': 'éƒ¨åˆ†å–å‡º'
}
db.add_transaction(sell_transaction)

# 4. æŸ¥çœ‹æ›´æ–°åçš„æŒä»“å’Œç»Ÿè®¡
positions = db.get_positions(ledger_id=1)
stats = db.get_portfolio_stats(ledger_id=1)

print(f"\nå½“å‰æŒä»“:")
print(positions[['code', 'name', 'quantity', 'avg_cost', 'current_price', 'profit_rate']])
print(f"\næŠ•èµ„ç»„åˆç»Ÿè®¡:")
print(f"æ€»æˆæœ¬: {stats['total_cost_cny']:,.2f} å…ƒ")
print(f"æ€»å¸‚å€¼: {stats['total_value_cny']:,.2f} å…ƒ")
print(f"æ€»ç›ˆäº: {stats['total_profit_cny']:,.2f} å…ƒ")
print(f"æ”¶ç›Šç‡: {stats['profit_rate']:.2f}%")

db.close()
```

### ç¤ºä¾‹ 2ï¼šè®°å½•åˆ†çº¢

```python
from database import Database

db = Database()

# è®°å½•åˆ†çº¢æ”¶å…¥
dividend_transaction = {
    'ledger_id': 1,
    'account_id': 1,
    'date': '2025-01-25',
    'type': 'åˆ†çº¢',
    'category': 'è‚¡ç¥¨',
    'code': 'SH.600519',
    'name': 'è´µå·èŒ…å°',
    'quantity': 0,  # åˆ†çº¢ä¸æ¶‰åŠæ•°é‡å˜åŒ–
    'price': 0,
    'currency': 'CNY',
    'amount': 5000.0,  # åˆ†çº¢é‡‘é¢
    'fee': 0,
    'notes': '2024å¹´åº¦åˆ†çº¢'
}
db.add_transaction(dividend_transaction)

# æŸ¥çœ‹åˆ†çº¢è®°å½•
dividends = db.get_transactions(ledger_id=1, trans_type='åˆ†çº¢')
print(dividends[['date', 'code', 'name', 'amount', 'notes']])

db.close()
```

### ç¤ºä¾‹ 3ï¼šèµ„é‡‘æ˜ç»†ç®¡ç†ï¼ˆå¤šå€Ÿå¤šè´·ï¼‰

```python
from database import Database

db = Database()

# è®°å½•æœ¬é‡‘æŠ•å…¥ï¼ˆå¤šå€Ÿå¤šè´·æ ¼å¼ï¼‰
fund_transaction = {
    'ledger_id': 1,
    'date': '2025-01-20',
    'type': 'æœ¬é‡‘æŠ•å…¥',
    'currency': 'CNY',
    'notes': 'åˆå§‹èµ„é‡‘æŠ•å…¥',
    'entries': [
        {
            'account_id': 1,  # é“¶è¡Œè´¦æˆ·
            'side': 'credit',  # è´·æ–¹ï¼ˆèµ„é‡‘æ¥æºï¼‰
            'amount': 100000.0
        },
        {
            'account_id': 2,  # è¯åˆ¸è´¦æˆ·
            'side': 'debit',  # å€Ÿæ–¹ï¼ˆèµ„é‡‘å»å‘ï¼‰
            'amount': 100000.0
        }
    ]
}
db.add_fund_transaction(fund_transaction)

# æŸ¥çœ‹èµ„é‡‘æ˜ç»†
fund_transactions = db.get_fund_transactions(ledger_id=1)
print(fund_transactions[['date', 'type', 'total_debit', 'total_credit', 'notes']])

db.close()
```

### ç¤ºä¾‹ 4ï¼šèµ„äº§å æ¯”åˆ†æ

```python
from database import Database

db = Database()

# è·å–èµ„äº§å æ¯”
allocation = db.analytics.get_asset_allocation(ledger_id=1)

print("èµ„äº§é…ç½®å æ¯”:")
print(allocation[['code', 'name', 'market_value_cny', 'allocation_percent']].to_string())

# æŒ‰ç±»åˆ«ç»Ÿè®¡
if not allocation.empty:
    category_allocation = allocation.groupby('category').agg({
        'market_value_cny': 'sum',
        'allocation_percent': 'sum'
    }).sort_values('market_value_cny', ascending=False)
    
    print("\næŒ‰ç±»åˆ«ç»Ÿè®¡:")
    print(category_allocation)

db.close()
```

### ç¤ºä¾‹ 5ï¼šä½¿ç”¨ä¸åŒçš„æˆæœ¬è®¡ç®—æ–¹æ³•

```python
from database import Database

db = Database()

# æŸ¥çœ‹è´¦æœ¬å½“å‰ä½¿ç”¨çš„æˆæœ¬è®¡ç®—æ–¹æ³•
ledger_id = 1
current_method = db.get_ledger_cost_method(ledger_id)
print(f"å½“å‰æˆæœ¬è®¡ç®—æ–¹æ³•: {current_method}")

# åˆ‡æ¢åˆ°åŠ æƒå¹³å‡æˆæœ¬æ³•ï¼ˆWACï¼‰
db.update_ledger_cost_method(ledger_id, 'WAC')

# é‡å»ºæŒä»“ï¼ˆä½¿ç”¨æ–°çš„æˆæœ¬è®¡ç®—æ–¹æ³•ï¼‰
db._rebuild_all_positions()

# æŸ¥çœ‹æ›´æ–°åçš„æŒä»“æˆæœ¬
positions = db.get_positions(ledger_id=ledger_id)
print(positions[['code', 'name', 'quantity', 'avg_cost']])

db.close()
```

---

## è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬çš„ `database.py`ï¼Œå¥½æ¶ˆæ¯æ˜¯ï¼š**æ— éœ€ä»»ä½•ä¿®æ”¹ï¼**

æ–°çš„æ¨¡å—åŒ–æ¶æ„å®Œå…¨å‘åå…¼å®¹ï¼Œæ‰€æœ‰åŸæœ‰çš„ä»£ç éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```python
# æ—§ä»£ç ï¼ˆä»ç„¶æœ‰æ•ˆï¼‰
from database import Database

db = Database()
db.add_transaction(transaction)
positions = db.get_positions()
stats = db.get_portfolio_stats()
```

### æ–°åŠŸèƒ½ä½¿ç”¨

å¦‚æœä½ æƒ³ä½¿ç”¨æ–°çš„æ¨¡å—åŒ–åŠŸèƒ½ï¼Œå¯ä»¥è¿™æ ·ï¼š

```python
from database import Database

db = Database()

# æ–¹å¼1ï¼šé€šè¿‡ä¸»å…¥å£ä½¿ç”¨ï¼ˆæ¨èï¼‰
db.add_transaction(transaction)
stats = db.get_portfolio_stats()

# æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨æ¨¡å—ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
db.transaction_crud.add_transaction(transaction, db.analytics)
stats = db.analytics.get_portfolio_stats()
allocation = db.analytics.get_asset_allocation()  # æ–°åŠŸèƒ½
```

---

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿æ¥**ï¼šä½¿ç”¨ `Database` ç±»æ—¶ï¼Œè®°å¾—åœ¨æœ€åè°ƒç”¨ `db.close()` å…³é—­è¿æ¥

2. **æˆæœ¬è®¡ç®—æ–¹æ³•**ï¼šæ¯ä¸ªè´¦æœ¬å¯ä»¥ç‹¬ç«‹è®¾ç½®æˆæœ¬è®¡ç®—æ–¹æ³•ï¼ˆFIFO æˆ– WACï¼‰ï¼Œä¿®æ”¹åä¼šè‡ªåŠ¨é‡å»ºæŒä»“

3. **æŒä»“åŒæ­¥**ï¼šæ·»åŠ ã€æ›´æ–°æˆ–åˆ é™¤äº¤æ˜“åï¼ŒæŒä»“ä¼šè‡ªåŠ¨æ›´æ–°ã€‚æ‰¹é‡æ“ä½œæ—¶ï¼Œå¯ä»¥è®¾ç½® `rebuild_positions=False` æœ€åç»Ÿä¸€é‡å»º

4. **æ±‡ç‡è½¬æ¢**ï¼šæ‰€æœ‰é‡‘é¢éƒ½ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºäººæ°‘å¸ï¼ˆCNYï¼‰è¿›è¡Œç»Ÿä¸€è®¡ç®—

5. **å¤šå€Ÿå¤šè´·**ï¼šèµ„é‡‘æ˜ç»†æ”¯æŒå¤šå€Ÿå¤šè´·æ ¼å¼ï¼Œç¡®ä¿å€Ÿè´·å¹³è¡¡

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- ä»£ç æ³¨é‡Š
- å„æ¨¡å—çš„æ–‡æ¡£å­—ç¬¦ä¸²
- ç¤ºä¾‹ä»£ç 

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-26

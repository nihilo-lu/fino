# 数据库结构与关联关系说明

- **数据库文件**：`/Users/lujiahui/Documents/python/investment_tracker/investment.db`
- **生成时间**：`2026-01-28 23:18:16`

## 总览

| 表名 | 行数 | 说明 |
| --- | ---: | --- |
| `accounts` | (跳过) | 账户（银行/券商等） |
| `categories` | (跳过) | 投资类别 |
| `currencies` | (跳过) | 币种与汇率 |
| `fund_transaction_entries` | (跳过) | 资金分录表（多借多贷，支持 subject_type） |
| `fund_transactions` | (跳过) | 资金明细主表（借贷记账法） |
| `ledgers` | (跳过) | 账本（按 owner_username 多用户隔离） |
| `positions` | (跳过) | 持仓快照（由 analytics 同步/重建） |
| `transactions` | (跳过) | 交易记录（买入/卖出/分红/开仓/平仓等） |

## 关系图（基于外键）

```mermaid
erDiagram
  accounts {
    INTEGER id PK
    INTEGER ledger_id NN
    TEXT name NN
    TEXT type NN
    INTEGER currency_id NN
    TEXT description
    TIMESTAMP created_at
  }
  categories {
    INTEGER id PK
    TEXT name NN
    TEXT description
    TIMESTAMP created_at
  }
  currencies {
    INTEGER id PK
    TEXT code NN
    TEXT name NN
    TEXT symbol NN
    REAL exchange_rate NN
    TIMESTAMP updated_at
  }
  fund_transaction_entries {
    INTEGER id PK
    INTEGER fund_transaction_id NN
    INTEGER account_id NN
    TEXT side NN
    REAL amount NN
    REAL amount_cny NN
    TIMESTAMP created_at
    TEXT subject_type
  }
  fund_transactions {
    INTEGER id PK
    INTEGER ledger_id NN
    TEXT date NN
    TEXT type NN
    INTEGER currency_id NN
    TEXT notes
    TIMESTAMP created_at
  }
  ledgers {
    INTEGER id PK
    TEXT name NN
    TEXT description
    TEXT cost_method
    TIMESTAMP created_at
    TEXT owner_username
  }
  positions {
    INTEGER id PK
    INTEGER ledger_id NN
    INTEGER account_id NN
    TEXT code NN
    TEXT name NN
    INTEGER category_id NN
    INTEGER currency_id NN
    REAL quantity NN
    REAL avg_cost NN
    REAL current_price NN
    TIMESTAMP updated_at
  }
  transactions {
    INTEGER id PK
    INTEGER ledger_id NN
    INTEGER account_id NN
    TEXT date NN
    TEXT type NN
    INTEGER category_id NN
    TEXT code NN
    TEXT name NN
    REAL quantity NN
    REAL price NN
    INTEGER currency_id NN
    REAL amount NN
    REAL amount_cny NN
    REAL fee
    TEXT notes
    TIMESTAMP created_at
  }
  currencies ||--o{ accounts : "currency_id"
  ledgers ||--o{ accounts : "ledger_id"
  accounts ||--o{ fund_transaction_entries : "account_id"
  fund_transactions ||--o{ fund_transaction_entries : "fund_transaction_id"
  currencies ||--o{ fund_transactions : "currency_id"
  ledgers ||--o{ fund_transactions : "ledger_id"
  currencies ||--o{ positions : "currency_id"
  categories ||--o{ positions : "category_id"
  accounts ||--o{ positions : "account_id"
  ledgers ||--o{ positions : "ledger_id"
  currencies ||--o{ transactions : "currency_id"
  categories ||--o{ transactions : "category_id"
  accounts ||--o{ transactions : "account_id"
  ledgers ||--o{ transactions : "ledger_id"
```

## 外键关系（强约束）

- **`accounts`.`currency_id` → `currencies`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`accounts`.`ledger_id` → `ledgers`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`fund_transaction_entries`.`account_id` → `accounts`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`fund_transaction_entries`.`fund_transaction_id` → `fund_transactions`.`id`**（ON DELETE CASCADE / ON UPDATE NO ACTION）
- **`fund_transactions`.`currency_id` → `currencies`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`fund_transactions`.`ledger_id` → `ledgers`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`positions`.`currency_id` → `currencies`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`positions`.`category_id` → `categories`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`positions`.`account_id` → `accounts`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`positions`.`ledger_id` → `ledgers`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`transactions`.`currency_id` → `currencies`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`transactions`.`category_id` → `categories`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`transactions`.`account_id` → `accounts`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）
- **`transactions`.`ledger_id` → `ledgers`.`id`**（ON DELETE NO ACTION / ON UPDATE NO ACTION）

## 软关联关系（无外键约束）

这些关系在业务代码中被当作“引用/枚举”使用，但数据库层没有建立 FOREIGN KEY。

- （未检测到软关联）

## 表结构明细

### `accounts`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE accounts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                ledger_id INTEGER NOT NULL,
                name TEXT NOT NULL,
                type TEXT NOT NULL,
                currency_id INTEGER NOT NULL,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (ledger_id) REFERENCES ledgers(id),
                FOREIGN KEY (currency_id) REFERENCES currencies(id),
                UNIQUE(ledger_id, name)
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `ledger_id` | `INTEGER` | Y | `` |  |
| 2 | `name` | `TEXT` | Y | `` |  |
| 3 | `type` | `TEXT` | Y | `` |  |
| 4 | `currency_id` | `INTEGER` | Y | `` |  |
| 5 | `description` | `TEXT` |  | `` |  |
| 6 | `created_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |

**索引/唯一约束**

| 名称 | UNIQUE | 列 |
| --- | :---: | --- |
| `sqlite_autoindex_accounts_1` | Y | `ledger_id`, `name` |

**外键**

- `currency_id` → `currencies`.`id`（ON DELETE NO ACTION）
- `ledger_id` → `ledgers`.`id`（ON DELETE NO ACTION）

### `categories`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE categories (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `name` | `TEXT` | Y | `` |  |
| 2 | `description` | `TEXT` |  | `` |  |
| 3 | `created_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |

**索引/唯一约束**

| 名称 | UNIQUE | 列 |
| --- | :---: | --- |
| `sqlite_autoindex_categories_1` | Y | `name` |

### `currencies`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE currencies (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                code TEXT UNIQUE NOT NULL,
                name TEXT NOT NULL,
                symbol TEXT NOT NULL,
                exchange_rate REAL NOT NULL,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `code` | `TEXT` | Y | `` |  |
| 2 | `name` | `TEXT` | Y | `` |  |
| 3 | `symbol` | `TEXT` | Y | `` |  |
| 4 | `exchange_rate` | `REAL` | Y | `` |  |
| 5 | `updated_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |

**索引/唯一约束**

| 名称 | UNIQUE | 列 |
| --- | :---: | --- |
| `sqlite_autoindex_currencies_1` | Y | `code` |

### `fund_transaction_entries`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE fund_transaction_entries (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                fund_transaction_id INTEGER NOT NULL,
                account_id INTEGER NOT NULL,
                side TEXT NOT NULL CHECK(side IN ('debit', 'credit')),
                amount REAL NOT NULL,
                amount_cny REAL NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, subject_type TEXT DEFAULT 'cash',
                FOREIGN KEY (fund_transaction_id) REFERENCES fund_transactions(id) ON DELETE CASCADE,
                FOREIGN KEY (account_id) REFERENCES accounts(id)
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `fund_transaction_id` | `INTEGER` | Y | `` |  |
| 2 | `account_id` | `INTEGER` | Y | `` |  |
| 3 | `side` | `TEXT` | Y | `` |  |
| 4 | `amount` | `REAL` | Y | `` |  |
| 5 | `amount_cny` | `REAL` | Y | `` |  |
| 6 | `created_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |
| 7 | `subject_type` | `TEXT` |  | `'cash'` |  |

**外键**

- `account_id` → `accounts`.`id`（ON DELETE NO ACTION）
- `fund_transaction_id` → `fund_transactions`.`id`（ON DELETE CASCADE）

### `fund_transactions`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE fund_transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                ledger_id INTEGER NOT NULL,
                date TEXT NOT NULL,
                type TEXT NOT NULL,
                currency_id INTEGER NOT NULL,
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (ledger_id) REFERENCES ledgers(id),
                FOREIGN KEY (currency_id) REFERENCES currencies(id)
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `ledger_id` | `INTEGER` | Y | `` |  |
| 2 | `date` | `TEXT` | Y | `` |  |
| 3 | `type` | `TEXT` | Y | `` |  |
| 4 | `currency_id` | `INTEGER` | Y | `` |  |
| 5 | `notes` | `TEXT` |  | `` |  |
| 6 | `created_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |

**外键**

- `currency_id` → `currencies`.`id`（ON DELETE NO ACTION）
- `ledger_id` → `ledgers`.`id`（ON DELETE NO ACTION）

### `ledgers`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE "ledgers" (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    description TEXT,
                    cost_method TEXT DEFAULT 'FIFO',
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    owner_username TEXT DEFAULT '',
                    UNIQUE(owner_username, name)
                )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `name` | `TEXT` | Y | `` |  |
| 2 | `description` | `TEXT` |  | `` |  |
| 3 | `cost_method` | `TEXT` |  | `'FIFO'` |  |
| 4 | `created_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |
| 5 | `owner_username` | `TEXT` |  | `''` |  |

**索引/唯一约束**

| 名称 | UNIQUE | 列 |
| --- | :---: | --- |
| `sqlite_autoindex_ledgers_1` | Y | `owner_username`, `name` |

### `positions`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE positions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                ledger_id INTEGER NOT NULL,
                account_id INTEGER NOT NULL,
                code TEXT NOT NULL,
                name TEXT NOT NULL,
                category_id INTEGER NOT NULL,
                currency_id INTEGER NOT NULL,
                quantity REAL NOT NULL,
                avg_cost REAL NOT NULL,
                current_price REAL NOT NULL,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (ledger_id) REFERENCES ledgers(id),
                FOREIGN KEY (account_id) REFERENCES accounts(id),
                FOREIGN KEY (category_id) REFERENCES categories(id),
                FOREIGN KEY (currency_id) REFERENCES currencies(id),
                UNIQUE(ledger_id, account_id, code)
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `ledger_id` | `INTEGER` | Y | `` |  |
| 2 | `account_id` | `INTEGER` | Y | `` |  |
| 3 | `code` | `TEXT` | Y | `` |  |
| 4 | `name` | `TEXT` | Y | `` |  |
| 5 | `category_id` | `INTEGER` | Y | `` |  |
| 6 | `currency_id` | `INTEGER` | Y | `` |  |
| 7 | `quantity` | `REAL` | Y | `` |  |
| 8 | `avg_cost` | `REAL` | Y | `` |  |
| 9 | `current_price` | `REAL` | Y | `` |  |
| 10 | `updated_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |

**索引/唯一约束**

| 名称 | UNIQUE | 列 |
| --- | :---: | --- |
| `sqlite_autoindex_positions_1` | Y | `ledger_id`, `account_id`, `code` |

**外键**

- `currency_id` → `currencies`.`id`（ON DELETE NO ACTION）
- `category_id` → `categories`.`id`（ON DELETE NO ACTION）
- `account_id` → `accounts`.`id`（ON DELETE NO ACTION）
- `ledger_id` → `ledgers`.`id`（ON DELETE NO ACTION）

### `transactions`

**建表语句（sqlite_master.sql）**

```sql
CREATE TABLE transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                ledger_id INTEGER NOT NULL,
                account_id INTEGER NOT NULL,
                date TEXT NOT NULL,
                type TEXT NOT NULL,
                category_id INTEGER NOT NULL,
                code TEXT NOT NULL,
                name TEXT NOT NULL,
                quantity REAL NOT NULL,
                price REAL NOT NULL,
                currency_id INTEGER NOT NULL,
                amount REAL NOT NULL,
                amount_cny REAL NOT NULL,
                fee REAL DEFAULT 0,
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (ledger_id) REFERENCES ledgers(id),
                FOREIGN KEY (account_id) REFERENCES accounts(id),
                FOREIGN KEY (category_id) REFERENCES categories(id),
                FOREIGN KEY (currency_id) REFERENCES currencies(id)
            )
```

**字段**

| 序号 | 字段 | 类型 | NOT NULL | 默认值 | 主键 |
| ---: | --- | --- | :---: | --- | :---: |
| 0 | `id` | `INTEGER` |  | `` | Y |
| 1 | `ledger_id` | `INTEGER` | Y | `` |  |
| 2 | `account_id` | `INTEGER` | Y | `` |  |
| 3 | `date` | `TEXT` | Y | `` |  |
| 4 | `type` | `TEXT` | Y | `` |  |
| 5 | `category_id` | `INTEGER` | Y | `` |  |
| 6 | `code` | `TEXT` | Y | `` |  |
| 7 | `name` | `TEXT` | Y | `` |  |
| 8 | `quantity` | `REAL` | Y | `` |  |
| 9 | `price` | `REAL` | Y | `` |  |
| 10 | `currency_id` | `INTEGER` | Y | `` |  |
| 11 | `amount` | `REAL` | Y | `` |  |
| 12 | `amount_cny` | `REAL` | Y | `` |  |
| 13 | `fee` | `REAL` |  | `0` |  |
| 14 | `notes` | `TEXT` |  | `` |  |
| 15 | `created_at` | `TIMESTAMP` |  | `CURRENT_TIMESTAMP` |  |

**外键**

- `currency_id` → `currencies`.`id`（ON DELETE NO ACTION）
- `category_id` → `categories`.`id`（ON DELETE NO ACTION）
- `account_id` → `accounts`.`id`（ON DELETE NO ACTION）
- `ledger_id` → `ledgers`.`id`（ON DELETE NO ACTION）

## 结合本项目代码的关键说明

- **类别与币种为物理外键**：`accounts`、`fund_transactions`、`positions`、`transactions` 使用 `category_id` → `categories.id`、`currency_id` → `currencies.id`。代码层通过 JOIN 取 `categories.name`、`currencies.code` 用于展示。
- **持仓 `positions` 是派生表**：由 `analytics` 基于 `transactions`（以及账本成本法 FIFO/WAC）更新/重建，用于加速查询与展示。
- **资金明细采用“主表 + 分录表”**：`fund_transactions` 为主记录；`fund_transaction_entries` 为多借多贷分录，且包含 `subject_type` 用于区分现金/持仓（开仓/平仓场景）。
- **账本多用户隔离**：`ledgers.owner_username` 对应登录用户名（config.yaml），查询时按该字段过滤，实现每用户独立账本与数据。

# 前后端分离改造说明

本文档说明如何将投资追踪器改为**前后端分离**部署，以提升运行性能与功能扩展能力。

## 一、当前架构简述

- **后端**：Flask，提供 REST API（`/api/*`），同时托管前端静态资源（`/frontend/*`）、首页与 SPA 回退路由（`/`、`/dashboard` 等）、`/manifest.json`、`/sw.js`。
- **前端**：Vue 3（ESM），通过相对路径 `/api` 请求后端，认证方式为 Session Cookie + 可选 Bearer Token。

改造后支持两种部署方式，并可平滑切换。

---

## 二、改造后的部署方式

### 方式 A：同源部署（推荐起步）

前端与 API 仍在**同一域名**下，由 Nginx（或 Caddy）统一入口：

- Nginx 提供静态资源（HTML/CSS/JS）、缓存、Gzip，不经过 Python。
- Nginx 将 `/api/*` 反向代理到 Flask（如 `http://127.0.0.1:8087`）。
- 会话 Cookie 同源，无需改认证逻辑。

**优点**：性能更好（静态走 Nginx）、前后端职责清晰、扩展时可单独扩容 API 服务。

### 方式 B：跨域部署

前端与 API 部署在**不同域名**（例如前端 `https://app.example.com`，API `https://api.example.com`）：

- 后端需开启 CORS（本项目已支持 `supports_credentials=True`）。
- 跨域下 Session Cookie 受浏览器限制，建议使用 **API Token（Bearer）** 进行认证（本项目已支持）。
- 前端需配置 API 基地址指向 `https://api.example.com`。

**优点**：前后端完全独立部署、可独立扩缩容与 CDN 加速前端。

---

## 三、后端改造要点

### 1. API 独立模式（仅提供接口）

在配置中开启 **API 独立模式** 后，Flask 不再提供首页、SPA 回退、静态文件、`manifest.json`、`sw.js`，仅提供 ` /api/*` 接口，便于与 Nginx 等反向代理配合。

**配置**（`conf/config.yaml`）：

```yaml
# ========== 服务端 ==========
server:
  api_only: false   # 设为 true 时仅提供 /api/*，不提供前端页面与静态资源
```

或通过环境变量（覆盖配置文件）：

```bash
export FINO_API_ONLY=1   # 1 或 true 表示仅 API
```

**使用场景**：

- 使用 Nginx 托管前端时，将 Flask 以 `api_only: true` 启动，由 Nginx 提供静态与 SPA 回退。
- 开发时保持 `api_only: false`，仍可由 Flask 直接提供完整前后端。

### 2. CORS

本项目已使用 `flask-cors` 且 `supports_credentials=True`。若采用**跨域部署**，需在 Nginx 或网关层保证不覆盖或重复设置 CORS 头；若需限制来源，可在 Flask 中配置 `CORS(app, origins=["https://app.example.com"], supports_credentials=True)`。

---

## 四、前端改造要点

### 1. API 基地址可配置

前端请求统一通过 `frontend/js/vue/utils/api.js` 中的 `API_BASE` 发出。`API_BASE` 可通过以下方式覆盖默认值 `/api`：

- **同源**：不设置则默认为 `/api`，由 Nginx 将 `/api` 代理到 Flask。
- **跨域**：在加载前端页面前注入 `window.__API_BASE__`，例如：

  ```html
  <script>
    window.__API_BASE__ = 'https://api.example.com/api';
  </script>
  ```

  再加载 `main.js`，则所有接口请求会发往该地址。

部署时可在 Nginx 的 `index.html` 注入、或由构建脚本替换占位符。

### 2. 认证方式建议

- **同源**：继续使用 Session Cookie 登录即可。
- **跨域**：建议使用「设置 → API Token」生成 Token，前端将 Token 存入内存或 localStorage，请求头携带 `Authorization: Bearer <token>`；后端已支持 Bearer 认证。

---

## 五、Nginx 示例（同源部署）

以下示例：前端静态文件在 `/var/www/fino/frontend`，Flask 运行在 `127.0.0.1:8087`，对外同一域名。

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/fino/frontend;

    # 静态资源：长期缓存
    location /frontend/ {
        alias /var/www/fino/frontend/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # API 全部转发到 Flask
    location /api/ {
        proxy_pass http://127.0.0.1:8087;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    }

    # PWA manifest / Service Worker 可由 Nginx 提供静态文件，或继续转发到 Flask
    location = /manifest.json {
        proxy_pass http://127.0.0.1:8087;
        proxy_set_header Host $host;
    }
    location = /sw.js {
        proxy_pass http://127.0.0.1:8087;
        proxy_set_header Host $host;
    }

    # SPA 回退：所有非文件请求返回 index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 根目录的 index.html
    location = /index.html {
        alias /var/www/fino/frontend/index.html;
    }
}
```

**注意**：若使用上述 Nginx 托管前端，请将 Flask 以 **API 独立模式**（`server.api_only: true` 或 `FINO_API_ONLY=1`）启动，避免重复提供静态与首页。

---

## 六、运行性能与扩展能力提升

| 方面       | 说明 |
|------------|------|
| 静态资源   | 由 Nginx/CDN 提供，可开启 Gzip、长期缓存，减少 Flask 负载。 |
| API 独立   | 仅 API 时 Flask 只处理业务请求，便于水平扩容、限流与监控。 |
| 前端扩展   | 后续可引入 Vite 等构建工具，做打包、代码分割、环境变量注入（如 `VITE_API_BASE`）。 |
| 跨域与多端 | 通过配置 `__API_BASE__` 与 Token 认证，同一套前端可对接不同环境或多后端。 |

---

## 七、配置项汇总

| 配置项 | 位置 | 说明 |
|--------|------|------|
| `server.api_only` | `conf/config.yaml` | 为 `true` 时仅提供 `/api/*`，不提供前端与静态。 |
| `FINO_API_ONLY` | 环境变量 | 覆盖 `server.api_only`，`1`/`true` 表示仅 API。 |
| `window.__API_BASE__` | 前端入口前注入 | 覆盖前端默认 API 基地址（默认 `/api`）。 |

按上述方式改造后，可在保持现有功能的前提下，逐步切换到同源 Nginx 部署或跨域分离部署，并为后续前端工程化（构建、多环境）预留空间。

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI åŠ©æ‰‹æµå¼ä¼ è¾“æµ‹è¯•é¡µ</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }
    h1 { margin: 0 0 8px; font-size: 1.25rem; }
    .subtitle { color: #888; font-size: 0.85rem; margin-bottom: 16px; }
    .container { max-width: 720px; margin: 0 auto; }
    .auth-warn {
      background: #3d2a1a;
      border: 1px solid #b8860b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .auth-warn a { color: #e8a317; }
    .messages {
      background: #16213e;
      border-radius: 8px;
      padding: 12px;
      min-height: 200px;
      max-height: 50vh;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .msg { margin-bottom: 12px; }
    .msg.user { color: #7dd3fc; }
    .msg.assistant .thinking {
      color: #a78bfa;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
    .msg.assistant .content { white-space: pre-wrap; word-break: break-word; }
    .cursor::after { content: 'â–Œ'; animation: blink 0.8s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .input-row textarea {
      flex: 1;
      min-height: 60px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #0f172a;
      color: #eee;
      resize: vertical;
    }
    .input-row button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: #e8a317;
      color: #1a1a2e;
      font-weight: 600;
      cursor: pointer;
    }
    .input-row button:disabled { opacity: 0.6; cursor: not-allowed; }
    .debug {
      background: #0f172a;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.8rem;
      font-family: ui-monospace, monospace;
    }
    .debug h3 { margin: 0 0 8px; font-size: 0.95rem; }
    .debug-row { margin-bottom: 4px; }
    .debug .label { color: #94a3b8; }
    .debug .value { color: #34d399; }
    .debug-log {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
      color: #64748b;
    }
    .debug-log .chunk { color: #a78bfa; }
    .error { color: #f87171; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– AI åŠ©æ‰‹æµå¼ä¼ è¾“æµ‹è¯•é¡µ</h1>
    <p class="subtitle">ç‹¬ç«‹é¡µé¢ï¼Œç”¨äºæ’æŸ¥æµå¼å“åº”æ˜¯å¦è¢«ç¼“å†²ã€æ˜¯å¦é€å—åˆ°è¾¾ã€‚è¯·å…ˆ<a href="/">ç™»å½•ä¸»ç«™</a>åå†ä½¿ç”¨ã€‚</p>

    <div id="authWarn" class="auth-warn" style="display: none;">
      æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸï¼Œè¯· <a href="/">è¿”å›é¦–é¡µç™»å½•</a> åå†ä½¿ç”¨æœ¬æµ‹è¯•é¡µã€‚API è¿”å› 401 æ—¶æ— æ³•è¿›è¡Œæµå¼æµ‹è¯•ã€‚
    </div>

    <div class="messages" id="messages">
      <div class="msg assistant">
        <div class="content">å‘é€ä¸€æ¡æ¶ˆæ¯å¼€å§‹æµ‹è¯•ã€‚ä¸‹æ–¹ã€Œæµå¼è°ƒè¯•ã€ä¼šæ˜¾ç¤ºé¦–åŒ…æ—¶é—´ä¸å—æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦çœŸæ­£æµå¼åˆ°è¾¾ã€‚</div>
      </div>
    </div>

    <div class="input-row">
      <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€" rows="2"></textarea>
      <button id="sendBtn" type="button">å‘é€</button>
    </div>

    <div class="debug">
      <h3>ğŸ“Š æµå¼è°ƒè¯•</h3>
      <div class="debug-row"><span class="label">é¦–åŒ…è€—æ—¶ï¼š</span><span id="firstChunkTime" class="value">-</span></div>
      <div class="debug-row"><span class="label">æ”¶åˆ°å—æ•°ï¼š</span><span id="chunkCount" class="value">0</span></div>
      <div class="debug-row"><span class="label">æ€»è€—æ—¶ï¼š</span><span id="totalTime" class="value">-</span></div>
      <div class="debug-row"><span class="label">Content-Typeï¼š</span><span id="contentType" class="value">-</span></div>
      <div class="debug-log" id="debugLog"></div>
    </div>
  </div>

  <script>
    const API_BASE = (typeof window !== 'undefined' && window.__API_BASE__) ? window.__API_BASE__ : '/api';
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const authWarn = document.getElementById('authWarn');
    const firstChunkTimeEl = document.getElementById('firstChunkTime');
    const chunkCountEl = document.getElementById('chunkCount');
    const totalTimeEl = document.getElementById('totalTime');
    const contentTypeEl = document.getElementById('contentType');
    const debugLogEl = document.getElementById('debugLog');

    function appendMsg(role, content, thinking, streaming) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + role;
      if (role === 'user') {
        wrap.innerHTML = '<div class="content"></div>';
        wrap.querySelector('.content').textContent = content;
      } else {
        let html = '';
        if (thinking) html += '<div class="thinking">ğŸ’­ ' + escapeHtml(thinking) + '</div>';
        html += '<div class="content' + (streaming ? ' cursor' : '') + '"></div>';
        wrap.innerHTML = html;
        wrap.querySelector('.content').textContent = content;
      }
      messagesEl.appendChild(wrap);
      return wrap;
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function scrollBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function logDebug(msg, isChunk) {
      const line = document.createElement('div');
      line.className = isChunk ? 'chunk' : '';
      line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
      debugLogEl.appendChild(line);
      debugLogEl.scrollTop = debugLogEl.scrollHeight;
    }

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;

      sendBtn.disabled = true;
      inputEl.value = '';

      appendMsg('user', text);
      const assistantWrap = appendMsg('assistant', '', '', true);
      const contentEl = assistantWrap.querySelector('.content');
      const thinkingEl = assistantWrap.querySelector('.thinking');

      // Reset debug
      firstChunkTimeEl.textContent = '-';
      chunkCountEl.textContent = '0';
      totalTimeEl.textContent = '-';
      contentTypeEl.textContent = '-';
      debugLogEl.innerHTML = '';

      const start = Date.now();
      let firstChunkAt = null;
      let chunkCount = 0;

      try {
        const res = await fetch(API_BASE + '/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            messages: [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªç®€æ´çš„åŠ©æ‰‹ã€‚' },
              { role: 'user', content: text }
            ],
            stream: true
          })
        });

        contentTypeEl.textContent = res.headers.get('Content-Type') || '-';

        if (res.status === 401) {
          authWarn.style.display = 'block';
          contentEl.textContent = 'æœªç™»å½•ï¼ˆ401ï¼‰ï¼Œè¯·å…ˆç™»å½•ä¸»ç«™ã€‚';
          contentEl.classList.remove('cursor');
          return;
        }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          contentEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + (err.error || res.statusText);
          contentEl.classList.remove('cursor');
          return;
        }

        authWarn.style.display = 'none';

        const reader = res.body && res.body.getReader();
        if (!reader) {
          contentEl.textContent = 'æ— æ³•è¯»å–æµï¼ˆresponse.body ä¸å¯ç”¨ï¼‰';
          contentEl.classList.remove('cursor');
          return;
        }

        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          if (firstChunkAt === null) {
            firstChunkAt = Date.now();
            firstChunkTimeEl.textContent = (firstChunkAt - start) + ' ms';
            logDebug('é¦–åŒ…åˆ°è¾¾', false);
          }

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          let thinkingBlock = assistantWrap.querySelector('.thinking');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              chunkCount++;
              chunkCountEl.textContent = chunkCount;
              if (chunkCount <= 5) logDebug('å— #' + chunkCount, true);

              try {
                const data = JSON.parse(line.slice(6));
                if (data.type === 'thinking' && data.content) {
                  if (!thinkingBlock) {
                    const div = document.createElement('div');
                    div.className = 'thinking';
                    div.textContent = 'ğŸ’­ ' + data.content;
                    assistantWrap.insertBefore(div, contentEl);
                    thinkingBlock = div;
                  } else {
                    thinkingBlock.textContent = 'ğŸ’­ ' + ((thinkingBlock.textContent || '').replace(/^ğŸ’­\s*/, '') + data.content);
                  }
                } else if (data.type === 'content' && data.content) {
                  contentEl.textContent = (contentEl.textContent || '') + data.content;
                }
              } catch (_) {}
            }
          }
          scrollBottom();
        }

        contentEl.classList.remove('cursor');
        totalTimeEl.textContent = (Date.now() - start) + ' ms';
        logDebug('æµç»“æŸï¼Œå…± ' + chunkCount + ' å—', false);

      } catch (e) {
        contentEl.textContent = 'é”™è¯¯: ' + (e.message || 'ç½‘ç»œæˆ–è§£æå¼‚å¸¸');
        contentEl.classList.remove('cursor');
        totalTimeEl.textContent = (Date.now() - start) + ' ms';
        logDebug('å¼‚å¸¸: ' + e.message, false);
      } finally {
        sendBtn.disabled = false;
        scrollBottom();
      }
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
